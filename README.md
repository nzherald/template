# Template
Basic template for setting up a new story

## Setup a new project
`npm install -g degit`

There are several branches in this project that contain similar versions of the
template with for different frameworks.

#### Minimal template
`degit nzherald/template`

#### Batteries included template
This template pulls in d3, d3-jetpack, jquery & lodash. It contains a big bag of components which you can pick and choose from.

`degit nzherald/template#batteries-included`

#### ObservableHQ template
`degit nzherald/template#observable`


## Installation
Webpack dev server should be ready to go as soon as packages are installed.
```
npm install
npm start
```


## Run modes
Usage: `npm run [option]`

`start`: Runs dev server with barebone template

`analyse`: Builds and runs bundle-analysis tools

`release`: Builds and pushes bundle files to homepage specified in package.json - embed details will be in `dist/zen.txt`

`livetest`: Builds and pushes bundle files to https://insights.nzherald.co.nz/app/livetest, which can be viewed at https://www.nzherald.co.nz/business/news/article.cfm?c_id=3&objectid=12234834

`homepagebanner`: Pushes straight to https://insights.nzherald.co.nz/apps/homepagebanner/ and overwrites existing banner. Obviously dangerous and disabled by default.


## Embedding in an article
To embed an interactive within an article it is necessary to insert:

`<div class='nzh-datavis' id='nzh-datavis-root'></div>`

The id can be varied - the class needs to always be `nzh-datavis`.

The `dist/zen.txt` will contain embed links for `embed.css` and `embed.js`.
These should be placed in the article's _raw footer_ and they only need to be included once.

The actual interactive is initiated with:

```
<link href="https://insights.nzherald.co.nz/apps/projectname/embed.css" rel="stylesheet">
<script src="https://insights.nzherald.co.nz/apps/projectname/embed.js"></script>
<script>
    window.addEventListener("load", function () {
        new window["projectname"]("#nzh-datavis-root", {});
    })
</script>
```

Make sure that the id matches the id of the div inserted into the article.


### Embedding multiple instances of the same visualisation
Each instance needs to have a different element:

```
    <div class='nzh-datavis' id='nzh-datavis-a'></div>
    <div class='nzh-datavis' id='nzh-datavis-b'></div>
```

Then run the visualisation once for each instance, pointing to the right element, with
the parameters specific to that instance.

```
<link href="https://insights.nzherald.co.nz/apps/projectname/embed.css" rel="stylesheet">
<script src="https://insights.nzherald.co.nz/apps/projectname/embed.js"></script>
<script>
    window.addEventListener("load", function () {
        new window["projectname"]("#nzh-datavis-a", { region: "Auckland" });
        new window["projectname"]("#nzh-datavis-b", { region: "Wellington" });
    })
</script>
```

The same method can be used to run instances of different visualisations. Each project is
expected to store its constructor in window. (Is there a better way to expose the project?)

```
<link href="https://insights.nzherald.co.nz/apps/projectname/embed.css" rel="stylesheet">
<link href="https://insights.nzherald.co.nz/apps/otherproject/embed.css" rel="stylesheet">
<script src="https://insights.nzherald.co.nz/apps/projectname/embed.js"></script>
<script src="https://insights.nzherald.co.nz/apps/otherproject/embed.js"></script>
<script>
    window.addEventListener("load", function () {
        new window["projectname"]("#nzh-datavis-a");
        new window["otherproject"]("#nzh-datavis-b");
    })
</script>
```


# Working in The App ^(;,;)^ ^(;,;)^ ^(;,;)^

### Fallback in the app
In the NZH mobile app interactives run within their own ReactNativeWebView - this means that some of
the features we like to use - primarily stick positioning - are unavailable. To include a prompt to
redirect to an actual browser window use the `appRedirect` argument:

`new window["projectname"]("#nzh-datavis-root", { appRedirect: "https://www.nzherald.co.nz/nz/dj-t2/DEYOM6DGQCKKAQ4WBYJB5UJAHU/" })`

...where the argument is the final URL of the article. You will need to publish the article to
generate the URL, then put the URL in and republish.

### The Unspeakable Eldritch Horrors
In most instances, the app creates a ReactNativeWebView iframe. This is generated by scraping the page
for the **first** `div.nzh-datavis` element. This means if you don't include a `.nzh-datavis` class, the
app will not find it, and nothing - not even the fallback redirect mechanism - will work.

Next, the app gathers all the scripts and styles from the footer. This is combined to generate a page
inside an iframe. This iframe comes with a `updateSize()` script which watches for size changes and
communicates that back to the parent via `window.ReactNativeWebView.postMessage()`.

This process means that the visualisation exists inside an iframe, and does not have access to the
stylesheets of the homepage. You'll need to bring your own fonts/styles. (Maybe you can include a link
to the homepage stylesheet in the footer? I haven't tested this.)

But also it only finds the first `div.nzh-datavis`, and lumps that element together with all the scripts,
so scripts which try to find other elements will fail. In theory, you could have multiple `div.nzh-datavis`
inside a parent `div.nzh-datavis` (which would be grabbed as the "first"). Maybe the children will be
replicated in the iframe? Or maybe the load script itself can generate more child elements before loading
the visualisations onto them?

I pray Cthulhu never read these unspeakable thoughts.

### The Unknowable Eldritch Secrets
Shorthand articles in the Android app are NOT created using this process. It seems to work normally. I
don't know what else are excempt.

All of this forbidden knowledge was stolen using `pageheist.js` (in the `batteries-included` branch). Very
handy tool, but it is unable to peer beyond the veil of the iframe. When you click on the visualisation in
the app, it opens up a mini window with the visualisation. I don't know how this behaviour works, as I
can't see beyond the iframe.

Surely nothing lies beyond but madness and the annihilation of being.
