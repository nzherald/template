---
title: "Home"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---

```{r, include=F}
library(tidyverse)
library(drake)
library(here)
library(ggthemes)
library(scales)
library(grid)
library(gridSVG)

source(here("code/functions.R"))

convicted_adults <- readd(convicted_adults)
```

_Example_


# Covid-19 Cases by DHB

```{r, fig.height=20}
plot <- convicted_adults %>%
  filter(ethnicity == "Total Ethnicity", sentence == "Total sentences") %>%
  ggplot(aes(x = calendar_year, y = value)) +
  geom_line(color = "#ecac0c", size = 1.2) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  xlab("Year") +
  ylab("Convictions") +
  labs(title = "Adults convicted in court") +
  theme_nzh()

plot
```

Save the plot for normal screens

```{r}
ggsave(here("interactive/src/assets/svg/convictions.svg"),
  plot = plot, dpi = 100, width = 6.2, height = 4)
```

Save the plot for small screens

```{r}
ggsave(here("interactive/src/assets/svg/convictions-small.svg"),
  plot = plot, dpi = 100, width = 3.2, height = 3)
```

Save the plot using gridSVG

```{r}

garnisher <- function(df) {
  function() {
    garnish_data <- df %>% mutate(ggr = grid.get("geom_rect", grep=T, global = T) %>% map_chr(function(g){g$name}))
    garnish_data %>% pmap(function(dhb, data, ggr) {
      grid.garnish(ggr, class=dhb)
    })
  }
}

plot_data <- cases %>%
    arrange(dhb,`date of report`) %>%
    group_by(dhb, reported=`date of report`) %>%
    summarise(n=n()) %>%
  ungroup() %>%
  group_nest(dhb)

grid_export(here("interactive/src/assets/svg/cases2.svg"),
  width = 6.2, height = 20, prefix = "",
  case_plot, garnish = garnisher(plot_data))

grid_export(here("interactive/src/assets/svg/cases2-small.svg"),
  width = 3.2, height = 20, prefix = "",
  case_plot, garnish = garnisher(plot_data))

jsonlite::write_json(r2d3::as_d3_data(plot_data), 
                     here("interactive/src/assets/svg/cases2.json"),
                     auto_unbox = T)
```

